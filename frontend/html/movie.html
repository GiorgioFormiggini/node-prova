<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMDB Clone - Dettagli Film</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./css/styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#3b82f6', // Blu acceso
                        'accent': '#10b981', // Verde per l'accento
                        'dark-bg': '#0d1117',
                        'card-bg': '#1f2937',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-dark-bg min-h-screen text-gray-100 p-4 sm:p-8">

    <header class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
        <h1 class="text-3xl font-bold text-primary tracking-wider">TMDB CLONE</h1>
        <nav class="flex space-x-4">
            <a href="home.html" class="text-gray-300 hover:text-accent font-medium transition duration-300">Home</a>
            <a href="favorites.html" id="favorites-link" class="text-gray-300 hover:text-accent font-medium transition duration-300">Preferiti</a>
                <button id="login-link" onclick="location.href='login.html'" class="bg-accent px-3 py-1 rounded-full text-white hover:bg-emerald-500 transition duration-300 shadow-lg">Accedi</button>
                <a href="signup.html" id="signup-link" class="text-gray-300 hover:text-accent font-medium transition duration-300">Registrati</a>
            <button id="logout-button" class="bg-red-600 px-3 py-1 rounded-full text-white hover:bg-red-700 transition duration-300 shadow-lg hidden">
                Logout
            </button>
        </nav>
    </header>

    <main class="pb-10 max-w-7xl mx-auto">
        
        <div id="message-box" class="mb-6 hidden"></div>

        <section id="movie-details-container" class="space-y-8">
            <!-- movie details will be injected here -->
        </section>

    </main>

    <footer class="mt-10 pt-4 border-t border-gray-800 text-center text-gray-500 text-sm">
        <p>&copy; 2025 TMDB Clone. Tutti i diritti riservati.</p>
    </footer>

    <script type="module" src="./js/api.js"></script>
    <script type="module" src="./js/ui.js"></script>
    <script type="module" src="./js/main.js"></script>
    <script src="./js/toast.js"></script>
    <script>
    function getQueryParam(name) {
        return new URLSearchParams(window.location.search).get(name);
    }

    function asDetails(obj) {
        // Support either top-level TMDB fields or nested details object
        if (!obj) return null;
        if (obj.details) return Object.assign({}, obj, obj.details);
        return obj;
    }

    async function isFavorite(tmdbId) {
        try {
            const token = localStorage.getItem('token');
            if (!token) return false;
            const res = await fetch('/api/movies/favorites', { headers: { 'Authorization': `Bearer ${token}` } });
            if (!res.ok) return false;
            const j = await res.json();
            if (!j.favorites) return false;
            return j.favorites.some(f => Number(f.tmdbId) === Number(tmdbId));
        } catch (e) { return false; }
    }

    async function toggleFavorite(tmdbId, title, btn) {
        const token = localStorage.getItem('token');
    if (!token) return showToast('Effettua il login per salvare i preferiti', 'warn');
        try {
            const res = await fetch('/api/movies/favorites', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify({ tmdbId: Number(tmdbId), title, isFavorite: true })
            });
            if (res.status === 409) {
                // already favorited
                showToast('Già aggiunto ai preferiti', 'warn');
                return null;
            }
            if (!res.ok) throw new Error('Errore salvataggio');
            const j = await res.json();
            btn.innerText = 'Aggiunto ai preferiti';
            btn.classList.remove('bg-primary');
            btn.classList.add('bg-green-600');
            btn.disabled = true;
            return j;
        } catch (err) {
            showToast('Impossibile salvare il preferito', 'error');
        }
    }

    async function loadMovie() {
        const id = getQueryParam('id');
        const container = document.getElementById('movie-details-container');
        if (!id) return container.innerText = 'ID film mancante';
        const res = await fetch(`/api/movies/${id}`);
        if (!res.ok) return container.innerText = 'Errore caricamento film';
        const json = await res.json();
        const d = asDetails(json);

        const genres = (d.genres && Array.isArray(d.genres)) ? d.genres.map(g => g.name || g).join(', ') : (d.genre_names || '—');
        const runtime = d.runtime ? `${d.runtime} min` : '—';
        const release_date = d.release_date || d.first_air_date || '—';
        const language = d.original_language || '—';
        const vote = d.vote_average ? `${d.vote_average} / 10` : '—';
        const vote_count = d.vote_count || 0;
        const popularity = d.popularity ? Number(d.popularity).toFixed(1) : '—';
        const poster = d.poster_path ? `https://image.tmdb.org/t/p/w500${d.poster_path}` : './img/no-poster.png';
        const backdrop = d.backdrop_path ? `https://image.tmdb.org/t/p/w780${d.backdrop_path}` : '';

        container.innerHTML = `
            <div class="flex flex-col lg:flex-row gap-8 bg-card-bg p-6 sm:p-10 rounded-2xl shadow-2xl">
                <div class="lg:w-1/3">
                    <img src="${poster}" alt="Poster ${d.title || ''}" class="w-full rounded-xl shadow-lg" />
                </div>
                <div class="lg:w-2/3 space-y-4">
                    <h2 class="text-3xl font-bold">${d.title || d.name || 'Titolo non disponibile'}</h2>
                    <p class="text-gray-400">${d.tagline ? `<em>${d.tagline}</em>` : ''}</p>
                    <div class="flex flex-wrap items-center gap-3">
                        <span class="px-3 py-1 rounded-full bg-gray-800 text-sm">${release_date}</span>
                        <span class="px-3 py-1 rounded-full bg-gray-800 text-sm">${runtime}</span>
                        <span class="px-3 py-1 rounded-full bg-gray-800 text-sm">Lingua: ${language}</span>
                        <span class="px-3 py-1 rounded-full bg-amber-400 text-black text-sm">⭐ ${vote} (${vote_count})</span>
                        <span class="px-3 py-1 rounded-full bg-gray-700 text-sm">Pop: ${popularity}</span>
                    </div>

                    <p class="text-gray-300">${d.overview || 'Nessuna overview disponibile.'}</p>

                    <div class="flex gap-3">
                        <button id="fav-btn" class="bg-primary text-white px-4 py-2 rounded">Salva ai preferiti</button>
                        <button id="watched-btn" class="bg-gray-700 text-white px-4 py-2 rounded">Segna come visto</button>
                        <a href="home.html" class="bg-gray-700 text-white px-4 py-2 rounded">Torna</a>
                    </div>

                    <div class="mt-4 text-sm text-gray-400">
                        <strong>Generi:</strong> ${genres}
                    </div>
                </div>
            </div>`;

        const favBtn = document.getElementById('fav-btn');
        const watchedBtn = document.getElementById('watched-btn');
        const already = await isFavorite(id);
        if (already) {
            favBtn.innerText = 'Già nei preferiti';
            favBtn.classList.remove('bg-primary');
            favBtn.classList.add('bg-green-600');
            // keep it enabled so user can click and receive feedback
        }

        // helper: get current status (favorite / watched) for this user+movie
        async function getStatusAPI(tmdbId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) return { isFavorite: false, isWatched: false };
                const res = await fetch(`/api/movies/status/${tmdbId}`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) return { isFavorite: false, isWatched: false };
                const j = await res.json();
                return j.status || { isFavorite: false, isWatched: false };
            } catch (e) { return { isFavorite: false, isWatched: false }; }
        }

        // initialize watched button state with eye SVG + green when watched
        if (watchedBtn) {
            const st = await getStatusAPI(id);
            function setDetailWatchedVisual(el, watched) {
                if (watched) {
                    el.innerText = 'Visto';
                    el.classList.remove('bg-gray-700');
                    el.classList.add('bg-green-600','border-green-600','text-white');
                } else {
                    el.innerText = 'Segna come visto';
                    el.classList.remove('bg-green-600','border-green-600','text-white');
                    el.classList.add('bg-gray-700');
                }
            }

            setDetailWatchedVisual(watchedBtn, st.isWatched);

            watchedBtn.addEventListener('click', async () => {
                const token = localStorage.getItem('token');
                if (!token) return showToast('Effettua il login per segnare come visto', 'warn');
                const shouldMark = !(st.isWatched || watchedSet.has(Number(id)));

                // optimistic UI
                setDetailWatchedVisual(watchedBtn, shouldMark);

                try {
                    const res = await fetch('/api/movies/watched', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                        body: JSON.stringify({ tmdbId: Number(id), isWatched: shouldMark })
                    });
                    if (!res.ok) {
                        showToast('Impossibile aggiornare lo stato visto', 'error');
                        setDetailWatchedVisual(watchedBtn, !shouldMark);
                        return;
                    }
                    const j = await res.json();
                    if (j.success) {
                        if (shouldMark) { watchedSet.add(Number(id)); showToast('Film segnato come visto', 'success'); }
                        else { watchedSet.delete(Number(id)); showToast('Film marcato come non visto', 'info'); }
                        // keep local st in sync
                        st.isWatched = shouldMark;
                    } else {
                        setDetailWatchedVisual(watchedBtn, !shouldMark);
                        showToast('Impossibile aggiornare lo stato', 'error');
                    }
                } catch (err) {
                    showToast('Errore di rete', 'error');
                    setDetailWatchedVisual(watchedBtn, !shouldMark);
                }
            });
        }

        favBtn.addEventListener('click', async () => {
            const token = localStorage.getItem('token');
            if (!token) return showToast('Effettua il login per salvare i preferiti', 'warn');
            if (await isFavorite(id)) {
                // show popup informing user it's already saved
                return showToast('Già aggiunto ai preferiti', 'warn');
            }
            await toggleFavorite(id, d.title || d.name, favBtn);
        });
    }

    loadMovie();
    </script>
   
</body>
</html>

